library(shiny)
library(tidyverse)
library(rlang)
library(readr)
library(forecast)
library(plotly)
library(glue)
# source("dataLoading.R")
# source("histogram.R")
# source("var_vs_time.R")
# source("bivariate_plot.R")
# source("NEE_bivariate.R")
# source("NEE_time_plot.R")


function(input, output, session){
  
  eddy_cov_time_variables = list("Julian Day" = "JD", "Month" = "DT", "Hours ofDay" =  "HM")
  # load data on push load_data
  start_path = "../data/processed_data/"
  data <- data_preview_server(id = "data_vars", start_path)
  
  # Getting head table 
  # TODO: Control number of lines 
  output$preview <- renderTable({
    head(data(), 10)
  })
  
  
  # Histogram plots  
  hist_plt <- histogram_server(id = "histo_plot", variables = variables, data = data()[seq(1,86400)]) 
  
  output$histogram <- renderPlotly({
    hist_plt()
  })
  
  #var vs time plots
  plot_var_vs_time_server(id = "time_plot", variables = variables, data = data())
  
  #pairplot
  pairplot <- bivariate_server(id = "bivar_plot", variables = variables, data = data())
  
  # render pairplot
  output$pairplot <- renderPlotly({
    suppressWarnings(pairplot$plot)
  })
  
              # ----------------------------------------------------- #
  eddy_cov_variables = list("Air Temperature" = "TA",
                            "Air Temperature Squared" = "TA.2",
                            "Photosynthetically Active Radiation" = "PPFD_in",
                            "Soil Moisture" = "Vol.W.C",
                            "Relative Humidity" = "RH",
                            "NEE" = "NEE")
  
  # nee file selection
  nee_data <- data_preview_server(id = "nee_data_vars", start_path)
  #nee_data <- readRDS("../data/processed_data/processed_silas_2018.rds")
  
  # Getting head table 
  # TODO: Control number of lines 
  output$nee_preview <- renderTable({
    head(nee_data(), 10)
  })
  
  # NEE time plot
  nee_time_plt <-  NEE_time_plot_server("NEE_var_vs_time", nee_data(), eddy_cov_time_variables,
                                        eddy_cov_variables)
  
  output$NEE_time_plot <- renderPlotly({
    suppressWarnings(nee_time_plt())
  })
  
  #NEE bivar_plt
  nee_bivar_plt <- NEE_bivar_server(id = "NEE_bivariate", variables = eddy_cov_variables, data = nee_data())
  
  output$NEE_bivariate_plot <- renderPlotly({
    suppressWarnings(nee_bivar_plt())
  })
}